<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizzatore Vendite - Percentuali Personalizzate</title>
    <!-- jsPDF library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 1400px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 3px solid #4CAF50;
            margin: 20px 0;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .tab.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .tab:hover:not(.active) {
            background: #e8f5e8;
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .upload-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .file-upload input[type=file] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .debug {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Custom Rates Table */
        .rates-section {
            margin: 30px 0;
        }
        .rates-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .rates-controls input, .rates-controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .rates-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .rates-table {
            width: 100%;
            border-collapse: collapse;
        }
        .rates-table th {
            background: #4CAF50;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .rates-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .rates-table input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }
        .rates-table input[type="number"]:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }
        .custom-rate {
            background: #fff3cd !important;
            border-left: 4px solid #ffc107 !important;
        }

        .shop-configured {
            background: #d4edda !important;
            border-left: 4px solid #28a745 !important;
        }
        .shop-unconfigured {
            background: #f8d7da !important;
            border-left: 4px solid #dc3545 !important;
        }
        .shop-found-in-csv {
            background: #d1ecf1 !important;
            border-left: 4px solid #17a2b8 !important;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
        }
        .status-configured {
            background: #28a745;
            color: white;
        }
        .status-unconfigured {
            background: #dc3545;
            color: white;
        }
        .status-found {
            background: #17a2b8;
            color: white;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .control-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .control-group input, .control-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-expand {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 10px;
        }

        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Pivot Table - Same as before */
        .pivot-container {
            margin: 30px 0;
        }
        .shop-row {
            background: #f8f9ff;
            border: 2px solid #e1e7ff;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }
        .shop-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f0f4ff, #e8f0ff);
            transition: background 0.3s ease;
        }
        .shop-header:hover {
            background: linear-gradient(135deg, #e8f0ff, #dde7ff);
        }
        .shop-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .shop-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c5aa0;
        }
        .shop-summary {
            font-size: 14px;
            color: #666;
        }
        .shop-metrics {
            display: flex;
            gap: 30px;
            text-align: center;
        }
        .shop-metric {
            display: flex;
            flex-direction: column;
        }
        .shop-metric-value {
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
        }
        .shop-metric-label {
            font-size: 12px;
            color: #666;
        }

        /* Comparison Mode Styles */
        .comparison-metrics {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .period-comparison {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            min-width: 120px;
        }

        .period-comparison:first-child {
            background: rgba(227, 242, 253, 0.3);
            border: 1px solid #e3f2fd;
        }

        .period-comparison:nth-child(2) {
            background: rgba(255, 243, 224, 0.3);
            border: 1px solid #fff3e0;
        }

        .period-label {
            font-size: 11px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .period-values {
            display: flex;
            flex-direction: column;
            text-align: center;
            gap: 2px;
        }

        .period-values div {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }

        /* Ensure better contrast for period labels */
        .period-comparison:first-child .period-label {
            color: #1565c0;
        }

        .period-comparison:nth-child(2) .period-label {
            color: #ef6c00;
        }

        .growth-indicators {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            background: rgba(248, 249, 250, 0.5);
            border: 1px solid #dee2e6;
        }

        .growth-metric {
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .significant-change {
            background: rgba(255, 235, 59, 0.1) !important;
            border-left: 3px solid #ff9800 !important;
        }

        .comparison-mode .shop-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .comparison-mode .shop-name {
            color: white;
        }

        .comparison-mode .shop-summary {
            color: rgba(255, 255, 255, 0.8);
        }

        .comparison-mode .expand-icon {
            color: white;
        }

        /* Responsive comparison mode */
        @media (max-width: 768px) {
            .comparison-metrics {
                flex-direction: column;
                gap: 10px;
            }

            .period-comparison {
                min-width: 100px;
            }
        }
        .expand-icon {
            font-size: 20px;
            transition: transform 0.3s ease;
            color: #4CAF50;
        }
        .shop-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        /* Operators Table */
        .operators-table {
            display: none;
            background: white;
            border-top: 1px solid #e1e7ff;
        }
        .shop-row.expanded .operators-table {
            display: block;
        }
        .operators-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .operators-table th {
            background: #5a67d8;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        .operators-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .operators-table tr:hover td {
            background-color: #f8f9fa;
        }

        /* Operator Rankings */
        .operator-rank-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 237, 78, 0.3)) !important;
            border-left: 4px solid #ffd700 !important;
            font-weight: bold;
        }
        .operator-rank-2 {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(211, 211, 211, 0.3)) !important;
            border-left: 4px solid #c0c0c0 !important;
            font-weight: bold;
        }
        .operator-rank-3 {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(228, 155, 80, 0.3)) !important;
            border-left: 4px solid #cd7f32 !important;
            font-weight: bold;
        }

        .currency {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .percentage {
            text-align: right;
            color: #2196F3;
            font-family: 'Courier New', monospace;
        }
        .text-center { text-align: center; }
        .hidden { display: none; }

        /* Search */
        .search-bar {
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .search-bar input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .search-bar select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .shop-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .shop-metrics {
                flex-direction: column;
                gap: 10px;
            }
            .controls {
                grid-template-columns: 1fr;
            }
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                margin-right: 0;
                margin-bottom: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 Analizzatore Vendite - Percentuali Personalizzate</h1>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('upload')">📁 Caricamento</div>
            <div class="tab" onclick="showTab('shops')">🏪 Negozi</div>
            <div class="tab" onclick="showTab('rates')">⚙️ Percentuali Custom</div>
            <div class="tab" onclick="showTab('results')">📊 Risultati</div>
        </div>

        <!-- Tab 1: Upload -->
        <div id="tab-upload" class="tab-content active">
            <div class="upload-section">
                <h3>Carica CSV</h3>
                <input type="file" id="csvFile" accept=".csv" />
            </div>
            <div id="debug" class="debug"></div>
        </div>

        <!-- Tab 2: Shops -->
        <div id="tab-shops" class="tab-content">
            <div class="rates-section">
                <h2>🏪 Configurazione Negozi</h2>

                <div class="rates-controls">
                    <button class="btn" onclick="loadDefaultShops()">📋 Carica Lista Default</button>
                    <button class="btn btn-secondary" onclick="clearAllShops()">🗑️ Pulisci Tutto</button>
                    <button class="btn" onclick="saveShops()">💾 Salva Configurazione</button>
                </div>

                <div class="rates-controls">
                    <label>🔍 Cerca Negozio:</label>
                    <input type="text" id="shopSearch" placeholder="Codice o nome..." style="flex: 1;" />

                    <label>Mostra:</label>
                    <select id="shopDisplayFilter">
                        <option value="all">Tutti i negozi</option>
                        <option value="configured">Solo configurati</option>
                        <option value="unconfigured">Solo da configurare</option>
                        <option value="found">Solo trovati nel CSV</option>
                    </select>

                    <button class="btn btn-secondary" onclick="clearShopFilters()">🗑️ Pulisci Filtri</button>
                </div>

                <div id="shopsTableContainer" class="rates-table-container hidden">
                    <table class="rates-table">
                        <thead>
                            <tr>
                                <th>🏷️ Codice</th>
                                <th>🏪 Nome Negozio</th>
                                <th>📊 Venduto CSV</th>
                                <th>👥 Operatori</th>
                                <th>📍 Status</th>
                                <th>🗑️ Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="shopsTableBody"></tbody>
                    </table>
                </div>

                <div id="noShopDataMessage" class="text-center" style="padding: 40px; color: #666;">
                    Carica prima un file CSV per configurare i negozi
                </div>
            </div>
        </div>

        <!-- Tab 3: Custom Rates -->
        <div id="tab-rates" class="tab-content">
            <div class="rates-section">
                <h2>⚙️ Configura Percentuali Personalizzate</h2>

                <div class="rates-controls">
                    <label>Percentuale Default:</label>
                    <input type="number" id="defaultRate" value="0.78" step="0.01" min="0" max="100" />
                    <span>%</span>

                    <button class="btn btn-secondary" onclick="applyDefaultToAll()">📄 Applica Default a Tutti</button>
                    <button class="btn btn-secondary" onclick="resetCustomRates()">🔄 Reset</button>
                    <button class="btn" onclick="saveRates()">💾 Salva Configurazione</button>
                </div>

                <div class="rates-controls">
                    <label>🔍 Cerca Dipendente:</label>
                    <input type="text" id="employeeSearch" placeholder="Nome dipendente..." style="flex: 1;" />

                    <label>Filtra per Negozio:</label>
                    <select id="employeeShopFilter" style="min-width: 150px;">
                        <option value="">Tutti i negozi</option>
                    </select>

                    <label>Mostra solo:</label>
                    <select id="ratesFilter">
                        <option value="all">Tutti</option>
                        <option value="custom">Solo % Personalizzate</option>
                        <option value="default">Solo % Default</option>
                    </select>

                    <button class="btn btn-secondary" onclick="clearFilters()">🗑️ Pulisci Filtri</button>
                </div>

                <div id="ratesTableContainer" class="rates-table-container hidden">
                    <table class="rates-table">
                        <thead>
                            <tr>
                                <th>👤 Operatore</th>
                                <th>🏪 Negozio</th>
                                <th>💰 Venduto Totale (€)</th>
                                <th>⚙️ % Personalizzata</th>
                                <th>🏆 Provvigioni con Default</th>
                                <th>🏆 Provvigioni Custom</th>
                                <th>📊 Differenza</th>
                            </tr>
                        </thead>
                        <tbody id="ratesTableBody"></tbody>
                    </table>
                </div>

                <div id="noDataMessage" class="text-center" style="padding: 40px; color: #666;">
                    Carica prima un file CSV per configurare le percentuali personalizzate
                </div>
            </div>
        </div>

        <!-- Tab 3: Results -->
        <div id="tab-results" class="tab-content">
            <div id="controls" class="controls hidden">
                <div class="control-group">
                    <label>Modalità Calcolo</label>
                    <select id="calculationMode">
                        <option value="default">Percentuale Default</option>
                        <option value="custom">Percentuali Personalizzate</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>📊 Modalità Analisi</label>
                    <select id="analysisMode" onchange="toggleComparisonMode()">
                        <option value="single">Singolo Periodo</option>
                        <option value="compare">Confronta Periodi</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Filtra per Negozio</label>
                    <select id="shopFilter">
                        <option value="">Tutti i negozi</option>
                    </select>
                </div>
                <div class="control-group" id="singlePeriodGroup">
                    <label>📅 Filtra per Periodo</label>
                    <select id="periodFilter">
                        <option value="">Tutti i periodi</option>
                    </select>
                </div>
                <div class="control-group hidden" id="periodAGroup">
                    <label>📅 Periodo A (Base)</label>
                    <select id="periodFilterA">
                        <option value="">Seleziona periodo A</option>
                    </select>
                </div>
                <div class="control-group hidden" id="periodBGroup">
                    <label>📅 Periodo B (Confronto)</label>
                    <select id="periodFilterB">
                        <option value="">Seleziona periodo B</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="processData()">🔄 Calcola Risultati</button>
                </div>
            </div>

            <div id="results" class="hidden">
                <div class="stats" id="stats"></div>

                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="🔍 Cerca negozio o operatore..." />
                    <select id="sortSelect">
                        <option value="commission">Ordina per Provvigioni</option>
                        <option value="sales">Ordina per Vendite</option>
                        <option value="operators">Ordina per N° Operatori</option>
                        <option value="name">Ordina per Nome</option>
                    </select>
                    <button class="btn-expand" onclick="toggleAllShops()">📖 Espandi Tutto</button>
                    <button class="btn" onclick="exportToPDF()" style="background: #dc3545;">📄 Esporta PDF</button>
                </div>

                <div class="pivot-container" id="pivotContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let pivotData = [];
        let customRates = {};
        let shopNames = {};
        let shopTotalsForMapping = {};
        let allExpanded = false;
        let operatorTotals = {};

        // Default shop names (from user's list)
        const defaultShopNames = {
            '002': 'MARZOCCA',
            '008': 'VALMONTONE',
            '0012': 'ANTEGNATE',
            '0038': 'FRANCIACORTA',
            '0059': 'MILANO',
            '0040': 'MOLFETTA',
            '0043': 'MANTOVA',
            '0044': 'PESCARA',
            '0046': 'NOVENTA',
            '0049': 'CASTELGUELFO',
            '0050': 'CASTELROMANO',
            '0053': 'VALDICHIANA',
            '0057': 'BRUGNATO',
            '0061': 'MONDOVI',
            '0063': 'MARCIANISE',
            '0064': 'ENNA',
            '0066': 'BARBERINO',
            '0067': 'TORINO',
            '0069': 'ORIO',
            '0003': 'JESI'
        };

        // Load saved rates from localStorage
        function loadSavedRates() {
            const saved = localStorage.getItem('customCommissionRates');
            if (saved) {
                customRates = JSON.parse(saved);
            }
        }

        // Load saved shop names from localStorage
        function loadSavedShopNames() {
            const saved = localStorage.getItem('shopNames');
            if (saved) {
                shopNames = JSON.parse(saved);
            }
        }

        // Save rates to localStorage
        function saveRates() {
            localStorage.setItem('customCommissionRates', JSON.stringify(customRates));
            alert('✅ Configurazione salvata con successo!');
        }

        // Save shop names to localStorage
        function saveShops() {
            localStorage.setItem('shopNames', JSON.stringify(shopNames));
            alert('✅ Configurazione negozi salvata con successo!');
        }

        // Load default shop names
        function loadDefaultShops() {
            if (confirm('Caricare la lista default dei negozi? Questo sovrascriverà le configurazioni attuali.')) {
                shopNames = { ...defaultShopNames };
                buildShopsTable();
            }
        }

        // Clear all shop names
        function clearAllShops() {
            if (confirm('Cancellare tutti i nomi dei negozi configurati?')) {
                shopNames = {};
                buildShopsTable();
            }
        }

        // Build shops table
        function buildShopsTable() {
            const container = document.getElementById('shopsTableContainer');
            const tbody = document.getElementById('shopsTableBody');
            const noDataMessage = document.getElementById('noShopDataMessage');

            // Check if we have CSV data
            if (rawData.length === 0) {
                container.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            // Get unique shops from CSV data
            const shopsInCSV = {};
            rawData.forEach(record => {
                const shop = record.codDep;
                if (!shopsInCSV[shop]) {
                    shopsInCSV[shop] = {
                        code: shop,
                        totalSales: 0,
                        operatorCount: new Set(),
                        transactions: 0
                    };
                }
                shopsInCSV[shop].totalSales += record.amount;
                shopsInCSV[shop].operatorCount.add(record.operatore);
                shopsInCSV[shop].transactions += 1;
            });

            // Convert operator sets to counts
            Object.values(shopsInCSV).forEach(shop => {
                shop.operatorCount = shop.operatorCount.size;
            });

            // Combine with all known shops (from defaults and saved)
            const allShops = {};

            // Add shops from CSV
            Object.values(shopsInCSV).forEach(shop => {
                allShops[shop.code] = shop;
            });

            // Add shops from default list that aren't in CSV
            Object.keys(defaultShopNames).forEach(code => {
                if (!allShops[code]) {
                    allShops[code] = {
                        code: code,
                        totalSales: 0,
                        operatorCount: 0,
                        transactions: 0
                    };
                }
            });

            // Add shops from saved configuration that aren't elsewhere
            Object.keys(shopNames).forEach(code => {
                if (!allShops[code]) {
                    allShops[code] = {
                        code: code,
                        totalSales: 0,
                        operatorCount: 0,
                        transactions: 0
                    };
                }
            });

            container.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            // Sort shops by code
            const sortedShops = Object.values(allShops).sort((a, b) => a.code.localeCompare(b.code));

            tbody.innerHTML = '';

            sortedShops.forEach(shop => {
                const configuredName = shopNames[shop.code] || '';
                const defaultName = defaultShopNames[shop.code] || '';
                const foundInCSV = shop.totalSales > 0;

                let statusClass = '';
                let statusText = '';
                let statusBadgeClass = '';

                if (configuredName) {
                    statusClass = 'shop-configured';
                    statusText = 'Configurato';
                    statusBadgeClass = 'status-configured';
                } else if (foundInCSV) {
                    statusClass = 'shop-found-in-csv';
                    statusText = 'Trovato nel CSV';
                    statusBadgeClass = 'status-found';
                } else {
                    statusClass = 'shop-unconfigured';
                    statusText = 'Da configurare';
                    statusBadgeClass = 'status-unconfigured';
                }

                const row = document.createElement('tr');
                row.className = statusClass;
                row.innerHTML = `
                    <td><strong>${shop.code}</strong></td>
                    <td>
                        <input type="text"
                               value="${configuredName || defaultName}"
                               placeholder="${defaultName || 'Inserisci nome...'}"
                               onchange="updateShopName('${shop.code}', this.value)"
                               style="width: 200px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;" />
                    </td>
                    <td class="currency">
                        ${foundInCSV ? '€' + shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2}) : '-'}
                    </td>
                    <td class="text-center">
                        ${foundInCSV ? shop.operatorCount : '-'}
                    </td>
                    <td class="text-center">
                        <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                    </td>
                    <td class="text-center">
                        ${configuredName || (foundInCSV && defaultName) ?
                            `<button onclick="deleteShop('${shop.code}')"
                                    style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;"
                                    title="Elimina negozio dalla configurazione">
                                🗑️ Elimina
                             </button>` :
                            '<span style="color: #999;">-</span>'
                        }
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Filter shops table
        function filterShopsTable() {
            const searchTerm = document.getElementById('shopSearch').value.toLowerCase();
            const displayFilter = document.getElementById('shopDisplayFilter').value;

            const tbody = document.getElementById('shopsTableBody');
            const rows = tbody.querySelectorAll('tr');

            let visibleRows = 0;

            rows.forEach(row => {
                const shopCode = row.cells[0].textContent.toLowerCase();
                const shopNameInput = row.cells[1].querySelector('input');
                const shopName = shopNameInput.value.toLowerCase();
                const hasStatusClass = row.classList.contains('shop-configured') ||
                                     row.classList.contains('shop-found-in-csv') ||
                                     row.classList.contains('shop-unconfigured');

                // Check search term
                const matchesSearch = searchTerm === '' ||
                                    shopCode.includes(searchTerm) ||
                                    shopName.includes(searchTerm);

                // Check display filter
                let matchesFilter = true;
                if (displayFilter === 'configured') {
                    matchesFilter = row.classList.contains('shop-configured');
                } else if (displayFilter === 'unconfigured') {
                    matchesFilter = row.classList.contains('shop-unconfigured');
                } else if (displayFilter === 'found') {
                    matchesFilter = row.classList.contains('shop-found-in-csv');
                }

                if (matchesSearch && matchesFilter) {
                    row.style.display = '';
                    visibleRows++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show/hide "no results" message for shops table
            const container = document.getElementById('shopsTableContainer');
            let noResultsMsg = container.querySelector('.no-shop-results-message');

            if (visibleRows === 0 && rows.length > 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-shop-results-message';
                    noResultsMsg.style.cssText = 'text-align: center; padding: 40px; color: #666; font-style: italic;';
                    noResultsMsg.innerHTML = '🔍 Nessun negozio trovato con i filtri attuali';
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        // Clear shop filters
        function clearShopFilters() {
            document.getElementById('shopSearch').value = '';
            document.getElementById('shopDisplayFilter').value = 'all';
            filterShopsTable();
        }

        // Update shop name
        function updateShopName(shopCode, newName) {
            if (newName.trim()) {
                shopNames[shopCode] = newName.trim();
            } else {
                delete shopNames[shopCode];
            }
            // Rebuild to update status
            buildShopsTable();
        }

        // Get display name for shop
        function getShopDisplayName(shopCode) {
            const name = shopNames[shopCode] || defaultShopNames[shopCode];
            return name ? `${shopCode}-${name}` : `Negozio ${shopCode}`;
        }

        // Delete shop from configuration
        function deleteShop(shopCode) {
            if (confirm(`Eliminare il negozio ${shopCode} dalla configurazione?\n\nQuesto rimuoverà solo la configurazione del nome, non i dati delle vendite.`)) {
                delete shopNames[shopCode];
                buildShopsTable();

                // Show confirmation message
                const container = document.getElementById('shopsTableContainer');
                const message = document.createElement('div');
                message.style.cssText = 'background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; text-align: center;';
                message.innerHTML = `✅ Negozio ${shopCode} rimosso dalla configurazione`;
                container.parentNode.insertBefore(message, container);

                setTimeout(() => {
                    message.remove();
                }, 3000);
            }
        }

        // Toggle between single and comparison mode
        function toggleComparisonMode() {
            const analysisMode = document.getElementById('analysisMode').value;
            const singleGroup = document.getElementById('singlePeriodGroup');
            const periodAGroup = document.getElementById('periodAGroup');
            const periodBGroup = document.getElementById('periodBGroup');

            if (analysisMode === 'compare') {
                singleGroup.classList.add('hidden');
                periodAGroup.classList.remove('hidden');
                periodBGroup.classList.remove('hidden');

                // Populate comparison period selectors
                populateComparisonPeriods();
            } else {
                singleGroup.classList.remove('hidden');
                periodAGroup.classList.add('hidden');
                periodBGroup.classList.add('hidden');
            }
        }

        // Populate period selectors for comparison
        function populateComparisonPeriods() {
            const periodsFound = new Set();
            rawData.forEach(record => {
                if (record.periodo !== 'SCONOSCIUTO') {
                    periodsFound.add(record.periodo);
                }
            });

            const periodFilterA = document.getElementById('periodFilterA');
            const periodFilterB = document.getElementById('periodFilterB');

            periodFilterA.innerHTML = '<option value="">Seleziona periodo A</option>';
            periodFilterB.innerHTML = '<option value="">Seleziona periodo B</option>';

            const sortedPeriods = Array.from(periodsFound).sort();
            sortedPeriods.forEach(periodo => {
                const recordsCount = rawData.filter(r => r.periodo === periodo).length;
                const [year, month] = periodo.split('-');
                const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu',
                                  'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                const monthName = monthNames[parseInt(month) - 1] || month;
                const optionText = `${monthName} ${year} (${recordsCount} trans.)`;

                periodFilterA.innerHTML += `<option value="${periodo}">${optionText}</option>`;
                periodFilterB.innerHTML += `<option value="${periodo}">${optionText}</option>`;
            });
        }

        // Load saved data on page load
        loadSavedRates();
        loadSavedShopNames();

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // File upload
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const text = event.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        });

        // Search and sort functionality
        document.getElementById('searchInput').addEventListener('input', filterPivotTable);
        document.getElementById('sortSelect').addEventListener('change', sortPivotTable);

        // Employee search and filter functionality
        document.getElementById('employeeSearch').addEventListener('input', filterRatesTable);
        document.getElementById('employeeShopFilter').addEventListener('change', filterRatesTable);
        document.getElementById('ratesFilter').addEventListener('change', filterRatesTable);

        // Shop search and filter functionality
        document.getElementById('shopSearch').addEventListener('input', filterShopsTable);
        document.getElementById('shopDisplayFilter').addEventListener('change', filterShopsTable);

        function parseCSV(text) {
            const debug = document.getElementById('debug');
            const lines = text.split('\n');

            let debugOutput = `File caricato: ${lines.length} righe\n\n`;

            rawData = [];

            // Same parsing logic as working version
            const firstDataLine = lines[1] || '';
            let separator = '';

            if (firstDataLine.includes(';')) {
                separator = ';';
                debugOutput += 'Separatore rilevato: punto e virgola (;)\n';
            } else if (firstDataLine.includes('\t')) {
                separator = '\t';
                debugOutput += 'Separatore rilevato: tab\n';
            } else {
                separator = 'spaces';
                debugOutput += 'Separatore rilevato: spazi multipli\n';
            }

            // Parse header
            let headers = [];
            if (separator === 'spaces') {
                headers = lines[0].split(/\s+/).filter(h => h.trim());
            } else {
                headers = lines[0].split(separator).map(h => h.trim());
            }

            // Find column indices
            const operatoreIndex = headers.findIndex(h =>
                h.toUpperCase().includes('OPERATORE') || h.toUpperCase() === 'OPERATORE'
            );
            const valNettoIndex = headers.findIndex(h =>
                h.toUpperCase().includes('VAL.NETTO') || h.toUpperCase().includes('NETTO')
            );
            const codDepIndex = headers.findIndex(h =>
                h.toUpperCase().includes('COD.DEP') || h.toUpperCase() === 'COD.DEP'
            );
            const dataIndex = headers.findIndex(h =>
                h.toUpperCase().includes('DATA') || h.toUpperCase() === 'DATA'
            );

            debugOutput += `Indici colonne:\n`;
            debugOutput += `OPERATORE: ${operatoreIndex} ("${headers[operatoreIndex] || 'NON TROVATO'}")\n`;
            debugOutput += `VAL.NETTO: ${valNettoIndex} ("${headers[valNettoIndex] || 'NON TROVATO'}")\n`;
            debugOutput += `COD.DEP: ${codDepIndex} ("${headers[codDepIndex] || 'NON TROVATO'}")\n`;
            debugOutput += `DATA: ${dataIndex} ("${headers[dataIndex] || 'NON TROVATO'}")\n\n`;

            if (operatoreIndex === -1 || valNettoIndex === -1) {
                debugOutput += '❌ ERRORE: Colonne OPERATORE o VAL.NETTO non trovate!\n';
                debug.textContent = debugOutput;
                return;
            }

            // Parse data
            let validRows = 0;
            const shops = new Set();

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                let columns = [];
                if (separator === 'spaces') {
                    columns = line.split(/\s+/).filter(c => c.trim());
                } else {
                    columns = line.split(separator).map(c => c.trim());
                }

                if (columns.length <= Math.max(operatoreIndex, valNettoIndex)) continue;

                const operatore = columns[operatoreIndex];
                const valNettoStr = columns[valNettoIndex];
                const codDep = codDepIndex >= 0 ? columns[codDepIndex] : 'N/A';
                const dataStr = dataIndex >= 0 ? columns[dataIndex] : '';

                if (!operatore || !valNettoStr) continue;

                // Parse amount
                let amount = 0;
                const cleanAmount = valNettoStr.replace(',', '.');
                amount = parseFloat(cleanAmount) || 0;

                // Parse date
                let parsedDate = null;
                let periodo = 'SCONOSCIUTO';

                if (dataStr) {
                    // Try different date formats: DD/MM/YYYY, DD-MM-YYYY, YYYY-MM-DD
                    const dateParts = dataStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})|(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);

                    if (dateParts) {
                        if (dateParts[1]) {
                            // DD/MM/YYYY or DD-MM-YYYY format
                            const day = parseInt(dateParts[1]);
                            const month = parseInt(dateParts[2]);
                            const year = parseInt(dateParts[3]);
                            parsedDate = new Date(year, month - 1, day);
                        } else {
                            // YYYY/MM/DD or YYYY-MM-DD format
                            const year = parseInt(dateParts[4]);
                            const month = parseInt(dateParts[5]);
                            const day = parseInt(dateParts[6]);
                            parsedDate = new Date(year, month - 1, day);
                        }

                        // Generate period string (YYYY-MM)
                        if (parsedDate && !isNaN(parsedDate.getTime())) {
                            const year = parsedDate.getFullYear();
                            const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
                            periodo = `${year}-${month}`;
                        }
                    }
                }

                if (amount > 0) {
                    rawData.push({
                        operatore: operatore,
                        amount: amount,
                        codDep: codDep,
                        data: dataStr,
                        parsedDate: parsedDate,
                        periodo: periodo
                    });
                    shops.add(codDep);
                    validRows++;
                }
            }

            debugOutput += `✅ Parsing completato: ${validRows} righe valide\n`;

            // Analyze detected periods
            const periodsFound = new Set();
            rawData.forEach(record => {
                if (record.periodo !== 'SCONOSCIUTO') {
                    periodsFound.add(record.periodo);
                }
            });

            if (periodsFound.size > 0) {
                debugOutput += `\n📅 Periodi rilevati: ${periodsFound.size}\n`;
                const sortedPeriods = Array.from(periodsFound).sort();
                sortedPeriods.forEach(periodo => {
                    const recordsInPeriod = rawData.filter(r => r.periodo === periodo).length;
                    debugOutput += `  • ${periodo}: ${recordsInPeriod} transazioni\n`;
                });

                if (periodsFound.size > 1) {
                    debugOutput += `\n✨ Multi-periodo rilevato! Puoi ora filtrare per periodo specifico.\n`;
                }
            } else {
                debugOutput += `\n⚠️ Nessuna data valida rilevata. Verifica formato colonna DATA.\n`;
            }

            debug.textContent = debugOutput;

            if (rawData.length > 0) {
                // Calculate operator totals for rates table
                calculateOperatorTotals();

                // Populate shop filter
                const shopFilter = document.getElementById('shopFilter');
                shopFilter.innerHTML = '<option value="">Tutti i negozi</option>';
                Array.from(shops).sort().forEach(shop => {
                    const displayName = getShopDisplayName(shop);
                    shopFilter.innerHTML += `<option value="${shop}">${displayName}</option>`;
                });

                // Populate employee shop filter
                const employeeShopFilter = document.getElementById('employeeShopFilter');
                employeeShopFilter.innerHTML = '<option value="">Tutti i negozi</option>';
                Array.from(shops).sort().forEach(shop => {
                    const displayName = getShopDisplayName(shop);
                    employeeShopFilter.innerHTML += `<option value="${shop}">${displayName}</option>`;
                });

                // Populate period filter
                const periodsFound = new Set();
                rawData.forEach(record => {
                    if (record.periodo !== 'SCONOSCIUTO') {
                        periodsFound.add(record.periodo);
                    }
                });

                const periodFilter = document.getElementById('periodFilter');
                periodFilter.innerHTML = '<option value="">Tutti i periodi</option>';
                const sortedPeriods = Array.from(periodsFound).sort();
                sortedPeriods.forEach(periodo => {
                    const recordsCount = rawData.filter(r => r.periodo === periodo).length;
                    const [year, month] = periodo.split('-');
                    const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu',
                                      'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                    const monthName = monthNames[parseInt(month) - 1] || month;
                    periodFilter.innerHTML += `<option value="${periodo}">${monthName} ${year} (${recordsCount} trans.)</option>`;
                });

                // Build shops table with loaded data
                buildShopsTable();

                // Show controls and rates table
                document.getElementById('controls').classList.remove('hidden');
                buildRatesTable();

                // Auto-switch to shops tab first
                showTab('shops');
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.querySelector('.tab:nth-child(1)').classList.remove('active');
            }
        }

        function calculateOperatorTotals() {
            operatorTotals = {};

            rawData.forEach(record => {
                if (!operatorTotals[record.operatore]) {
                    operatorTotals[record.operatore] = {
                        operatore: record.operatore,
                        codDep: record.codDep,
                        totalSales: 0,
                        transactions: 0
                    };
                }
                operatorTotals[record.operatore].totalSales += record.amount;
                operatorTotals[record.operatore].transactions += 1;
            });
        }

        function buildRatesTable() {
            const container = document.getElementById('ratesTableContainer');
            const tbody = document.getElementById('ratesTableBody');
            const noDataMessage = document.getElementById('noDataMessage');

            if (Object.keys(operatorTotals).length === 0) {
                container.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            const defaultRate = parseFloat(document.getElementById('defaultRate').value) / 100;

            // Sort operators by total sales
            const sortedOperators = Object.values(operatorTotals).sort((a, b) => b.totalSales - a.totalSales);

            tbody.innerHTML = '';

            sortedOperators.forEach(operator => {
                const customRate = customRates[operator.operatore] || defaultRate;
                const defaultCommission = operator.totalSales * defaultRate;
                const customCommission = operator.totalSales * customRate;
                const difference = customCommission - defaultCommission;

                const row = document.createElement('tr');
                if (customRates[operator.operatore]) {
                    row.classList.add('custom-rate');
                }

                const shopDisplayName = getShopDisplayName(operator.codDep);
                row.innerHTML = `
                    <td><strong>${operator.operatore}</strong></td>
                    <td>${shopDisplayName}</td>
                    <td class="currency">€${operator.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td class="text-center">
                        <input type="number" value="${(customRate * 100).toFixed(2)}"
                               step="0.01" min="0" max="100"
                               onchange="updateCustomRate('${operator.operatore}', this.value)"
                               style="width: 70px;" />%
                    </td>
                    <td class="currency">€${defaultCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td class="currency">€${customCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td class="currency" style="color: ${difference >= 0 ? '#28a745' : '#dc3545'};">
                        ${difference >= 0 ? '+' : ''}€${difference.toLocaleString('it-IT', {minimumFractionDigits: 2})}
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateCustomRate(operatore, newRate) {
            const rate = parseFloat(newRate) / 100;
            if (rate >= 0) {
                customRates[operatore] = rate;
                buildRatesTable(); // Rebuild to update calculations
            }
        }

        function applyDefaultToAll() {
            if (confirm('Applicare la percentuale default a tutti gli operatori?')) {
                customRates = {};
                buildRatesTable();
            }
        }

        function resetCustomRates() {
            if (confirm('Cancellare tutte le percentuali personalizzate?')) {
                customRates = {};
                localStorage.removeItem('customCommissionRates');
                buildRatesTable();
            }
        }

        function processData() {
            if (rawData.length === 0) return;

            const calculationMode = document.getElementById('calculationMode').value;
            const analysisMode = document.getElementById('analysisMode').value;
            const defaultRate = parseFloat(document.getElementById('defaultRate').value) / 100;
            const shopFilter = document.getElementById('shopFilter').value;

            if (analysisMode === 'compare') {
                processComparisonData();
                return;
            }

            // Single period mode (existing logic)
            const periodFilter = document.getElementById('periodFilter').value;

            // Filter data if needed
            let filteredData = rawData;
            let filterInfo = '';

            if (shopFilter) {
                filteredData = filteredData.filter(r => r.codDep === shopFilter);
                const shopName = getShopDisplayName(shopFilter);
                filterInfo += `Negozio: ${shopName} • `;
            }

            if (periodFilter) {
                filteredData = filteredData.filter(r => r.periodo === periodFilter);
                const [year, month] = periodFilter.split('-');
                const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                                  'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
                const monthName = monthNames[parseInt(month) - 1] || month;
                filterInfo += `Periodo: ${monthName} ${year} • `;
            }

            // Store filter info for display
            window.currentFilterInfo = filterInfo;

            // Group by shop and operator
            const shopOperatorGroups = {};
            const shopTotals = {};

            filteredData.forEach(record => {
                const shopKey = record.codDep;
                const operatorKey = `${record.codDep}|${record.operatore}`;

                // Shop totals
                if (!shopTotals[shopKey]) {
                    shopTotals[shopKey] = {
                        shop: shopKey,
                        totalSales: 0,
                        operators: new Set(),
                        transactions: 0
                    };
                }
                shopTotals[shopKey].totalSales += record.amount;
                shopTotals[shopKey].operators.add(record.operatore);
                shopTotals[shopKey].transactions += 1;

                // Shop-Operator combinations
                if (!shopOperatorGroups[operatorKey]) {
                    shopOperatorGroups[operatorKey] = {
                        shop: record.codDep,
                        operatore: record.operatore,
                        totalSales: 0,
                        transactions: 0
                    };
                }
                shopOperatorGroups[operatorKey].totalSales += record.amount;
                shopOperatorGroups[operatorKey].transactions += 1;
            });

            // Process pivot data with custom rates
            pivotData = [];
            Object.values(shopTotals).forEach(shop => {
                shop.operatorCount = shop.operators.size;

                // Get operators for this shop
                const shopOperators = Object.values(shopOperatorGroups)
                    .filter(item => item.shop === shop.shop)
                    .map(op => {
                        // Use custom rate if available, otherwise default
                        const rate = calculationMode === 'custom' && customRates[op.operatore] ?
                                   customRates[op.operatore] : defaultRate;

                        return {
                            ...op,
                            rate: rate,
                            commission: op.totalSales * rate,
                            percentageInShop: (op.totalSales / shop.totalSales) * 100,
                            isCustomRate: calculationMode === 'custom' && customRates[op.operatore] !== undefined
                        };
                    })
                    .sort((a, b) => b.commission - a.commission);

                // Calculate shop totals
                shop.commission = shopOperators.reduce((sum, op) => sum + op.commission, 0);
                shop.avgPerOperator = shop.operatorCount > 0 ? shop.commission / shop.operatorCount : 0;
                shop.operators = shopOperators;
                pivotData.push(shop);
            });

            // Sort shops by commission
            pivotData.sort((a, b) => b.commission - a.commission);

            renderResults();
        }

        // Process comparison between two periods
        function processComparisonData() {
            const calculationMode = document.getElementById('calculationMode').value;
            const defaultRate = parseFloat(document.getElementById('defaultRate').value) / 100;
            const shopFilter = document.getElementById('shopFilter').value;
            const periodA = document.getElementById('periodFilterA').value;
            const periodB = document.getElementById('periodFilterB').value;

            if (!periodA || !periodB) {
                alert('⚠️ Seleziona entrambi i periodi per il confronto!');
                return;
            }

            if (periodA === periodB) {
                alert('⚠️ Seleziona due periodi diversi per il confronto!');
                return;
            }

            // Filter data for both periods
            let dataA = rawData.filter(r => r.periodo === periodA);
            let dataB = rawData.filter(r => r.periodo === periodB);

            if (shopFilter) {
                dataA = dataA.filter(r => r.codDep === shopFilter);
                dataB = dataB.filter(r => r.codDep === shopFilter);
            }

            // Process both periods separately
            const resultA = processDataForPeriod(dataA, calculationMode, defaultRate, 'A');
            const resultB = processDataForPeriod(dataB, calculationMode, defaultRate, 'B');

            // Create comparison data structure
            pivotData = createComparisonData(resultA, resultB, periodA, periodB);

            // Set filter info for comparison
            const [yearA, monthA] = periodA.split('-');
            const [yearB, monthB] = periodB.split('-');
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            const monthNameA = monthNames[parseInt(monthA) - 1];
            const monthNameB = monthNames[parseInt(monthB) - 1];

            let filterInfo = `Confronto: ${monthNameA} ${yearA} vs ${monthNameB} ${yearB} • `;
            if (shopFilter) {
                const shopName = getShopDisplayName(shopFilter);
                filterInfo += `Negozio: ${shopName} • `;
            }

            window.currentFilterInfo = filterInfo;
            window.isComparisonMode = true;
            window.periodA = periodA;
            window.periodB = periodB;

            renderResults();
        }

        // Helper function to process data for a single period
        function processDataForPeriod(data, calculationMode, defaultRate, periodLabel) {
            const shopOperatorGroups = {};
            const shopTotals = {};

            data.forEach(record => {
                const shopKey = record.codDep;
                const operatorKey = `${record.codDep}|${record.operatore}`;

                // Shop totals
                if (!shopTotals[shopKey]) {
                    shopTotals[shopKey] = {
                        shop: shopKey,
                        totalSales: 0,
                        operators: new Set(),
                        transactions: 0
                    };
                }
                shopTotals[shopKey].totalSales += record.amount;
                shopTotals[shopKey].operators.add(record.operatore);
                shopTotals[shopKey].transactions += 1;

                // Shop-Operator combinations
                if (!shopOperatorGroups[operatorKey]) {
                    shopOperatorGroups[operatorKey] = {
                        shop: record.codDep,
                        operatore: record.operatore,
                        totalSales: 0,
                        transactions: 0
                    };
                }
                shopOperatorGroups[operatorKey].totalSales += record.amount;
                shopOperatorGroups[operatorKey].transactions += 1;
            });

            // Process pivot data
            const pivotResult = [];
            Object.values(shopTotals).forEach(shop => {
                shop.operatorCount = shop.operators.size;

                const shopOperators = Object.values(shopOperatorGroups)
                    .filter(item => item.shop === shop.shop)
                    .map(op => {
                        const rate = calculationMode === 'custom' && customRates[op.operatore] ?
                                   customRates[op.operatore] : defaultRate;

                        return {
                            ...op,
                            rate: rate,
                            commission: op.totalSales * rate,
                            percentageInShop: (op.totalSales / shop.totalSales) * 100,
                            isCustomRate: calculationMode === 'custom' && customRates[op.operatore] !== undefined
                        };
                    })
                    .sort((a, b) => b.commission - a.commission);

                shop.commission = shopOperators.reduce((sum, op) => sum + op.commission, 0);
                shop.avgPerOperator = shop.operatorCount > 0 ? shop.commission / shop.operatorCount : 0;
                shop.operators = shopOperators;
                pivotResult.push(shop);
            });

            return pivotResult.sort((a, b) => b.commission - a.commission);
        }

        // Create comparison data structure with growth calculations
        function createComparisonData(resultA, resultB, periodA, periodB) {
            const comparisonData = [];

            // Get all shops from both periods
            const allShops = new Set();
            resultA.forEach(shop => allShops.add(shop.shop));
            resultB.forEach(shop => allShops.add(shop.shop));

            Array.from(allShops).forEach(shopCode => {
                const shopA = resultA.find(s => s.shop === shopCode);
                const shopB = resultB.find(s => s.shop === shopCode);

                const salesA = shopA ? shopA.totalSales : 0;
                const salesB = shopB ? shopB.totalSales : 0;
                const commissionA = shopA ? shopA.commission : 0;
                const commissionB = shopB ? shopB.commission : 0;

                // Calculate growth percentages
                const salesGrowth = salesA > 0 ? ((salesB - salesA) / salesA) * 100 : (salesB > 0 ? 100 : 0);
                const commissionGrowth = commissionA > 0 ? ((commissionB - commissionA) / commissionA) * 100 : (commissionB > 0 ? 100 : 0);

                comparisonData.push({
                    shop: shopCode,
                    periodA: periodA,
                    periodB: periodB,
                    salesA: salesA,
                    salesB: salesB,
                    commissionA: commissionA,
                    commissionB: commissionB,
                    salesGrowth: salesGrowth,
                    commissionGrowth: commissionGrowth,
                    operatorCountA: shopA ? shopA.operatorCount : 0,
                    operatorCountB: shopB ? shopB.operatorCount : 0,
                    transactionsA: shopA ? shopA.transactions : 0,
                    transactionsB: shopB ? shopB.transactions : 0,
                    // Keep detailed operator data for expanded view
                    operatorsA: shopA ? shopA.operators : [],
                    operatorsB: shopB ? shopB.operators : []
                });
            });

            return comparisonData.sort((a, b) => Math.abs(b.salesGrowth) - Math.abs(a.salesGrowth));
        }

        function renderResults() {
            renderStats();
            renderPivotTable();
            document.getElementById('results').classList.remove('hidden');

            // Auto-switch to results tab
            showTab('results');
            document.querySelector('.tab:nth-child(3)').classList.add('active');
            document.querySelectorAll('.tab').forEach((tab, index) => {
                if (index !== 2) tab.classList.remove('active');
            });
        }

        function renderStats() {
            const calculationMode = document.getElementById('calculationMode').value;
            const modeText = calculationMode === 'custom' ? 'Personalizzate' : 'Default';

            // Add filter info if present
            let filterDisplay = '';
            if (window.currentFilterInfo) {
                filterDisplay = `<div style="text-align: center; margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; color: #1976d2; font-weight: bold;">📊 ${window.currentFilterInfo.slice(0, -3)}</div>`;
            }

            if (window.isComparisonMode) {
                // Comparison mode stats
                const totalSalesA = pivotData.reduce((sum, shop) => sum + shop.salesA, 0);
                const totalSalesB = pivotData.reduce((sum, shop) => sum + shop.salesB, 0);
                const totalCommissionA = pivotData.reduce((sum, shop) => sum + shop.commissionA, 0);
                const totalCommissionB = pivotData.reduce((sum, shop) => sum + shop.commissionB, 0);
                const totalShops = pivotData.length;

                const salesGrowth = totalSalesA > 0 ? ((totalSalesB - totalSalesA) / totalSalesA) * 100 : 0;
                const commissionGrowth = totalCommissionA > 0 ? ((totalCommissionB - totalCommissionA) / totalCommissionA) * 100 : 0;

                const salesGrowthColor = salesGrowth >= 0 ? '#28a745' : '#dc3545';
                const commissionGrowthColor = commissionGrowth >= 0 ? '#28a745' : '#dc3545';
                const salesGrowthIcon = salesGrowth >= 0 ? '📈' : '📉';
                const commissionGrowthIcon = commissionGrowth >= 0 ? '📈' : '📉';

                document.getElementById('stats').innerHTML = filterDisplay + `
                    <div class="stat-card">
                        <div class="stat-value">${totalShops}</div>
                        <div>Negozi Analizzati</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${totalSalesA.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                        <div>Vendite Periodo A</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${totalSalesB.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                        <div>Vendite Periodo B</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, ${salesGrowthColor}, ${salesGrowthColor}cc);">
                        <div class="stat-value">${salesGrowthIcon} ${salesGrowth > 0 ? '+' : ''}${salesGrowth.toFixed(1)}%</div>
                        <div>Crescita Vendite</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${totalCommissionA.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                        <div>Provvigioni A ${modeText}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${totalCommissionB.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                        <div>Provvigioni B ${modeText}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, ${commissionGrowthColor}, ${commissionGrowthColor}cc);">
                        <div class="stat-value">${commissionGrowthIcon} ${commissionGrowth > 0 ? '+' : ''}${commissionGrowth.toFixed(1)}%</div>
                        <div>Crescita Provvigioni</div>
                    </div>
                `;
            } else {
                // Single period mode (existing logic)
                const totalSales = pivotData.reduce((sum, shop) => sum + shop.totalSales, 0);
                const totalCommission = pivotData.reduce((sum, shop) => sum + shop.commission, 0);
                const totalOperators = pivotData.reduce((sum, shop) => sum + shop.operatorCount, 0);
                const totalShops = pivotData.length;

                document.getElementById('stats').innerHTML = filterDisplay + `
                    <div class="stat-card">
                        <div class="stat-value">${totalShops}</div>
                        <div>Negozi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalOperators}</div>
                        <div>Operatori</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                        <div>Venduto Totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">€${totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                        <div>Provvigioni ${modeText}</div>
                    </div>
                `;
            }
        }


        function renderPivotTable() {
            if (window.isComparisonMode) {
                renderComparisonPivotTable();
            } else {
                renderSinglePeriodPivotTable();
            }
        }

        function renderSinglePeriodPivotTable() {
            const container = document.getElementById('pivotContainer');
            if (pivotData.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Nessun dato disponibile</p>';
                return;
            }
            let html = '';
            pivotData.forEach((shop, shopIndex) => {
                const shopDisplayName = getShopDisplayName(shop.shop);
                html += `
                    <div class="shop-row" data-shop="${shop.shop}" data-shop-name="${shopDisplayName.toLowerCase()}">
                        <div class="shop-header" onclick="toggleShop(${shopIndex})">
                            <div class="shop-info">
                                <div class="shop-name">🏪 ${shopDisplayName}</div>
                                <div class="shop-summary">
                                    ${shop.operatorCount} operatori • ${shop.transactions} transazioni
                                </div>
                            </div>
                            <div class="shop-metrics">
                                <div class="shop-metric">
                                    <div class="shop-metric-value">€${shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                    <div class="shop-metric-label">Venduto</div>
                                </div>
                                <div class="shop-metric">
                                    <div class="shop-metric-value">€${shop.commission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                    <div class="shop-metric-label">Provvigioni</div>
                                </div>
                                <div class="shop-metric">
                                    <div class="shop-metric-value">€${shop.avgPerOperator.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                    <div class="shop-metric-label">Media Operatore</div>
                                </div>
                                <div class="expand-icon">▶</div>
                            </div>
                        </div>
                        <div class="operators-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="text-align: center;">Pos.</th>
                                        <th>👤 Operatore</th>
                                        <th>⚙️ % Rate</th>
                                        <th>💰 Venduto (€)</th>
                                        <th>🏆 Provvigione (€)</th>
                                        <th>📊 % nel Negozio</th>
                                        <th>🔢 Transazioni</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                shop.operators.forEach((operator, index) => {
                    let rowClass = '';
                    let position = '';
                    if (index === 0) {
                        rowClass = 'operator-rank-1';
                        position = '🥇';
                    } else if (index === 1) {
                        rowClass = 'operator-rank-2';
                        position = '🥈';
                    } else if (index === 2) {
                        rowClass = 'operator-rank-3';
                        position = '🥉';
                    } else {
                        position = `${index + 1}°`;
                    }
                    if (operator.isCustomRate) {
                        rowClass += ' custom-rate';
                    }
                    const rateDisplay = operator.isCustomRate ?
                        `<strong>${(operator.rate * 100).toFixed(2)}%</strong> ⚙️` :
                        `${(operator.rate * 100).toFixed(2)}%`;
                    html += `
                        <tr class="${rowClass}">
                            <td class="text-center"><strong>${position}</strong></td>
                            <td><strong>${operator.operatore}</strong></td>
                            <td class="text-center">${rateDisplay}</td>
                            <td class="currency">${operator.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                            <td class="currency">${operator.commission.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                            <td class="percentage">${operator.percentageInShop.toFixed(2)}%</td>
                            <td class="text-center">${operator.transactions}</td>
                        </tr>
                    `;
                });
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderComparisonPivotTable() {
            const container = document.getElementById('pivotContainer');
            if (pivotData.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Nessun dato disponibile</p>';
                return;
            }

            const periodA = document.getElementById('periodFilterA').selectedOptions[0]?.text || 'Periodo A';
            const periodB = document.getElementById('periodFilterB').selectedOptions[0]?.text || 'Periodo B';

            let html = '';
            pivotData.forEach((shop, shopIndex) => {
                const shopDisplayName = getShopDisplayName(shop.shop);
                const salesGrowth = shop.salesA > 0 ? ((shop.salesB - shop.salesA) / shop.salesA) * 100 : (shop.salesB > 0 ? 100 : 0);
                const commissionGrowth = shop.commissionA > 0 ? ((shop.commissionB - shop.commissionA) / shop.commissionA) * 100 : (shop.commissionB > 0 ? 100 : 0);

                const salesGrowthColor = salesGrowth >= 0 ? '#28a745' : '#dc3545';
                const commissionGrowthColor = commissionGrowth >= 0 ? '#28a745' : '#dc3545';
                const salesGrowthIcon = salesGrowth >= 0 ? '📈' : '📉';
                const commissionGrowthIcon = commissionGrowth >= 0 ? '📈' : '📉';

                html += `
                    <div class="shop-row comparison-mode" data-shop="${shop.shop}" data-shop-name="${shopDisplayName.toLowerCase()}">
                        <div class="shop-header" onclick="toggleShop(${shopIndex})">
                            <div class="shop-info">
                                <div class="shop-name">🏪 ${shopDisplayName}</div>
                                <div class="shop-summary">
                                    ${Math.max((shop.operatorsA?.length || 0), (shop.operatorsB?.length || 0))} operatori attivi
                                </div>
                            </div>
                            <div class="shop-metrics">
                                <div class="comparison-metrics">
                                    <div class="period-comparison">
                                        <div class="period-label">${periodA}</div>
                                        <div class="period-values">
                                            <div>€${shop.salesA.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                            <div>€${shop.commissionA.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                        </div>
                                    </div>
                                    <div class="period-comparison">
                                        <div class="period-label">${periodB}</div>
                                        <div class="period-values">
                                            <div>€${shop.salesB.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                            <div>€${shop.commissionB.toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                                        </div>
                                    </div>
                                    <div class="growth-indicators">
                                        <div class="growth-metric" style="color: ${salesGrowthColor};">
                                            ${salesGrowthIcon} ${salesGrowth > 0 ? '+' : ''}${salesGrowth.toFixed(1)}%
                                        </div>
                                        <div class="growth-metric" style="color: ${commissionGrowthColor};">
                                            ${commissionGrowthIcon} ${commissionGrowth > 0 ? '+' : ''}${commissionGrowth.toFixed(1)}%
                                        </div>
                                    </div>
                                </div>
                                <div class="expand-icon">▶</div>
                            </div>
                        </div>
                        <div class="operators-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th rowspan="2" style="text-align: center; vertical-align: middle;">👤 Operatore</th>
                                        <th colspan="3" style="text-align: center; background: #e3f2fd;">${periodA}</th>
                                        <th colspan="3" style="text-align: center; background: #fff3e0;">${periodB}</th>
                                        <th rowspan="2" style="text-align: center; vertical-align: middle;">📈 Crescita</th>
                                    </tr>
                                    <tr>
                                        <th style="background: #e3f2fd;">💰 Venduto</th>
                                        <th style="background: #e3f2fd;">🏆 Provvigione</th>
                                        <th style="background: #e3f2fd;">🔢 Trans.</th>
                                        <th style="background: #fff3e0;">💰 Venduto</th>
                                        <th style="background: #fff3e0;">🏆 Provvigione</th>
                                        <th style="background: #fff3e0;">🔢 Trans.</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                // Get all operators from both periods
                const allOperators = new Set([
                    ...(shop.operatorsA || []).map(op => op.operatore),
                    ...(shop.operatorsB || []).map(op => op.operatore)
                ]);

                // Create combined operator data for comparison
                const combinedOperators = Array.from(allOperators).map(operatorName => {
                    const opA = (shop.operatorsA || []).find(op => op.operatore === operatorName);
                    const opB = (shop.operatorsB || []).find(op => op.operatore === operatorName);

                    const salesA = opA ? opA.totalSales : 0;
                    const salesB = opB ? opB.totalSales : 0;
                    const commissionA = opA ? opA.commission : 0;
                    const commissionB = opB ? opB.commission : 0;
                    const transactionsA = opA ? opA.transactions : 0;
                    const transactionsB = opB ? opB.transactions : 0;

                    const growthPercent = salesA > 0 ? ((salesB - salesA) / salesA) * 100 : (salesB > 0 ? 100 : 0);

                    return {
                        operatore: operatorName,
                        salesA, salesB, commissionA, commissionB,
                        transactionsA, transactionsB, growthPercent,
                        totalSales: salesA + salesB, // For sorting
                        isCustomRate: (opA && opA.isCustomRate) || (opB && opB.isCustomRate)
                    };
                }).sort((a, b) => b.totalSales - a.totalSales);

                combinedOperators.forEach((operator, index) => {
                    const growthColor = operator.growthPercent >= 0 ? '#28a745' : '#dc3545';
                    const growthIcon = operator.growthPercent >= 0 ? '📈' : '📉';

                    let rowClass = '';
                    if (operator.isCustomRate) {
                        rowClass += 'custom-rate ';
                    }

                    // Highlight significant changes
                    if (Math.abs(operator.growthPercent) > 20) {
                        rowClass += 'significant-change ';
                    }

                    html += `
                        <tr class="${rowClass}">
                            <td><strong>${operator.operatore}</strong></td>
                            <td class="currency" style="background: #f8f9fa;">€${operator.salesA.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                            <td class="currency" style="background: #f8f9fa;">€${operator.commissionA.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                            <td class="text-center" style="background: #f8f9fa;">${operator.transactionsA}</td>
                            <td class="currency" style="background: #fff8e1;">€${operator.salesB.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                            <td class="currency" style="background: #fff8e1;">€${operator.commissionB.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                            <td class="text-center" style="background: #fff8e1;">${operator.transactionsB}</td>
                            <td class="text-center" style="color: ${growthColor}; font-weight: bold;">
                                ${growthIcon} ${operator.growthPercent > 0 ? '+' : ''}${operator.growthPercent.toFixed(1)}%
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function toggleShop(shopIndex) {
            const shopRow = document.querySelectorAll('.shop-row')[shopIndex];
            const isExpanded = shopRow.classList.contains('expanded');

            if (isExpanded) {
                shopRow.classList.remove('expanded');
            } else {
                shopRow.classList.add('expanded');
            }
        }

        function toggleAllShops() {
            const shopRows = document.querySelectorAll('.shop-row');
            allExpanded = !allExpanded;

            shopRows.forEach(row => {
                if (allExpanded) {
                    row.classList.add('expanded');
                } else {
                    row.classList.remove('expanded');
                }
            });

            document.querySelector('.btn-expand').textContent =
                allExpanded ? '📕 Chiudi Tutto' : '📖 Espandi Tutto';
        }

        function filterPivotTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const shopRows = document.querySelectorAll('.shop-row');

            shopRows.forEach(row => {
                const shopCode = row.getAttribute('data-shop').toLowerCase();
                const shopName = row.getAttribute('data-shop-name').toLowerCase();
                const operatorCells = row.querySelectorAll('.operators-table tbody tr td:nth-child(2)');
                let hasMatchingOperator = false;

                operatorCells.forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        hasMatchingOperator = true;
                    }
                });

                if (shopCode.includes(searchTerm) || shopName.includes(searchTerm) || hasMatchingOperator || searchTerm === '') {
                    row.style.display = 'block';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function sortPivotTable() {
            const sortBy = document.getElementById('sortSelect').value;
            let sortedData = [...pivotData];

            switch (sortBy) {
                case 'commission':
                    sortedData.sort((a, b) => b.commission - a.commission);
                    break;
                case 'sales':
                    sortedData.sort((a, b) => b.totalSales - a.totalSales);
                    break;
                case 'operators':
                    sortedData.sort((a, b) => b.operatorCount - a.operatorCount);
                    break;
                case 'name':
                    sortedData.sort((a, b) => a.shop.localeCompare(b.shop));
                    break;
            }

            pivotData = sortedData;
            renderPivotTable();
        }

        function filterRatesTable() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const shopFilter = document.getElementById('employeeShopFilter').value;
            const ratesFilter = document.getElementById('ratesFilter').value;

            const tbody = document.getElementById('ratesTableBody');
            const rows = tbody.querySelectorAll('tr');

            let visibleRows = 0;

            rows.forEach(row => {
                const operatorName = row.cells[0].textContent.toLowerCase();
                const operatorShopDisplay = row.cells[1].textContent;
                const hasCustomRate = row.classList.contains('custom-rate');

                // Extract shop code from the display name to match filter
                let operatorShopCode = '';
                // Find shop code by reverse lookup from display name
                Object.keys(operatorTotals).forEach(opName => {
                    const op = operatorTotals[opName];
                    if (row.cells[0].textContent === op.operatore) {
                        operatorShopCode = op.codDep;
                    }
                });

                // Check search term
                const matchesSearch = searchTerm === '' || operatorName.includes(searchTerm);

                // Check shop filter
                const matchesShop = shopFilter === '' || operatorShopCode === shopFilter;

                // Check rates filter
                let matchesRatesFilter = true;
                if (ratesFilter === 'custom') {
                    matchesRatesFilter = hasCustomRate;
                } else if (ratesFilter === 'default') {
                    matchesRatesFilter = !hasCustomRate;
                }

                if (matchesSearch && matchesShop && matchesRatesFilter) {
                    row.style.display = '';
                    visibleRows++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show/hide "no results" message
            const container = document.getElementById('ratesTableContainer');
            let noResultsMsg = container.querySelector('.no-results-message');

            if (visibleRows === 0 && rows.length > 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-results-message';
                    noResultsMsg.style.cssText = 'text-align: center; padding: 40px; color: #666; font-style: italic;';
                    noResultsMsg.innerHTML = '🔍 Nessun dipendente trovato con i filtri attuali';
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        function clearFilters() {
            document.getElementById('employeeSearch').value = '';
            document.getElementById('employeeShopFilter').value = '';
            document.getElementById('ratesFilter').value = 'all';
            filterRatesTable();
        }

        // PDF Export functionality
        function exportToPDF() {
            if (pivotData.length === 0) {
                alert('Nessun dato da esportare. Elabora prima i dati!');
                return;
            }

            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Helper function to clean text from problematic characters
            function cleanText(text) {
                return text
                    .replace(/📊/g, '[CHART]')
                    .replace(/📈/g, '[TREND]')
                    .replace(/🏪/g, '[SHOP]')
                    .replace(/🥇/g, '1°')
                    .replace(/🥈/g, '2°')
                    .replace(/🥉/g, '3°')
                    .replace(/📝/g, '[NOTE]')
                    .replace(/⭐/g, '[STAR]')
                    .replace(/⚙️/g, '*')
                    .replace(/€/g, 'EUR ')
                    .replace(/à/g, 'a\'')
                    .replace(/è/g, 'e\'')
                    .replace(/é/g, 'e\'')
                    .replace(/ì/g, 'i\'')
                    .replace(/ò/g, 'o\'')
                    .replace(/ù/g, 'u\'');
            }

            // Get current date and calculation mode
            const currentDate = new Date().toLocaleDateString('it-IT');
            const calculationMode = document.getElementById('calculationMode').value;
            const modeText = calculationMode === 'custom' ? 'Personalizzate' : 'Default';

            // Calculate totals
            const totalSales = pivotData.reduce((sum, shop) => sum + shop.totalSales, 0);
            const totalCommission = pivotData.reduce((sum, shop) => sum + shop.commission, 0);
            const totalOperators = pivotData.reduce((sum, shop) => sum + shop.operatorCount, 0);
            const totalShops = pivotData.length;

            // PDF Header
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text(cleanText('[CHART] ANALISI VENDITE - REPORT DETTAGLIATO'), 105, 20, { align: 'center' });

            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(cleanText(`Data Generazione: ${currentDate}`), 20, 30);
            doc.text(cleanText(`Modalita\' Calcolo: Percentuali ${modeText}`), 20, 36);

            // Summary Statistics
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(cleanText('[TREND] RIEPILOGO GENERALE'), 20, 50);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const summaryY = 58;
            doc.text(cleanText(`Negozi Analizzati: ${totalShops}`), 20, summaryY);
            doc.text(cleanText(`Operatori Totali: ${totalOperators}`), 20, summaryY + 6);
            doc.text(cleanText(`Venduto Totale: EUR ${totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}`), 20, summaryY + 12);
            doc.text(cleanText(`Provvigioni Totali: EUR ${totalCommission.toLocaleString('it-IT', {minimumFractionDigits: 2})}`), 20, summaryY + 18);

            // Line separator
            doc.setLineWidth(0.5);
            doc.line(20, summaryY + 25, 190, summaryY + 25);

            let currentY = summaryY + 35;

            // TOP 10 Global Performers Section
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(cleanText('[STAR] TOP 10 VENDITORI GLOBALI'), 20, currentY);
            currentY += 10;

            // Collect all operators from all shops for global ranking
            const allOperators = [];
            pivotData.forEach(shop => {
                shop.operators.forEach(operator => {
                    allOperators.push({
                        operatore: operator.operatore,
                        shopCode: shop.shop,
                        shopName: getShopDisplayName(shop.shop),
                        totalSales: operator.totalSales,
                        commission: operator.commission,
                        rate: operator.rate,
                        isCustomRate: operator.isCustomRate,
                        transactions: operator.transactions
                    });
                });
            });

            // Sort by total sales and take top 10
            const top10Global = allOperators
                .sort((a, b) => b.totalSales - a.totalSales)
                .slice(0, 10);

            // Create TOP 10 table data
            const top10TableData = [];
            top10Global.forEach((operator, index) => {
                const position = index + 1;
                let positionDisplay = `${position}°`;
                if (position === 1) positionDisplay = `1° [GOLD]`;
                else if (position === 2) positionDisplay = `2° [SILVER]`;
                else if (position === 3) positionDisplay = `3° [BRONZE]`;

                const rateDisplay = operator.isCustomRate ?
                    `${(operator.rate * 100).toFixed(2)}% *` :
                    `${(operator.rate * 100).toFixed(2)}%`;

                top10TableData.push([
                    positionDisplay,
                    cleanText(operator.operatore),
                    cleanText(operator.shopName),
                    rateDisplay,
                    `EUR ${operator.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}`,
                    `EUR ${operator.commission.toLocaleString('it-IT', {minimumFractionDigits: 2})}`,
                    operator.transactions.toString()
                ]);
            });

            // Add TOP 10 table
            doc.autoTable({
                startY: currentY,
                head: [['Pos.', 'Operatore', 'Negozio', '% Rate', 'Venduto (EUR)', 'Provvigione (EUR)', 'Trans.']],
                body: top10TableData,
                theme: 'grid',
                headStyles: {
                    fillColor: [255, 193, 7], // Golden color for global ranking
                    textColor: [0, 0, 0],
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 20 }, // Position
                    1: { cellWidth: 35 }, // Operatore
                    2: { cellWidth: 30 }, // Negozio
                    3: { halign: 'center', cellWidth: 18 }, // Rate
                    4: { halign: 'right', cellWidth: 30 }, // Venduto
                    5: { halign: 'right', cellWidth: 30 }, // Provvigione
                    6: { halign: 'center', cellWidth: 15 } // Transazioni
                },
                margin: { left: 20, right: 20 },
                didDrawCell: function (data) {
                    // Highlight top 3 global performers
                    if (data.section === 'body') {
                        const rowIndex = data.row.index;
                        if (rowIndex === 0) {
                            data.cell.styles.fillColor = [255, 215, 0, 0.5]; // Gold
                            data.cell.styles.fontStyle = 'bold';
                        } else if (rowIndex === 1) {
                            data.cell.styles.fillColor = [192, 192, 192, 0.5]; // Silver
                            data.cell.styles.fontStyle = 'bold';
                        } else if (rowIndex === 2) {
                            data.cell.styles.fillColor = [205, 127, 50, 0.5]; // Bronze
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                }
            });

            currentY = doc.lastAutoTable.finalY + 20;

            // Add some info about the global ranking
            doc.setFontSize(8);
            doc.setFont(undefined, 'italic');
            doc.text(cleanText('Nota: Classifica basata sul venduto totale di ciascun operatore'), 20, currentY);
            currentY += 15;

            // Line separator before shop details
            doc.setLineWidth(0.5);
            doc.line(20, currentY, 190, currentY);
            currentY += 10;

            // Iterate through each shop
            pivotData.forEach((shop, shopIndex) => {
                // Check if we need a new page
                if (currentY > 250) {
                    doc.addPage();
                    currentY = 20;
                }

                const shopDisplayName = getShopDisplayName(shop.shop);

                // Shop Header
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(cleanText(`[SHOP] ${shopDisplayName}`), 20, currentY);

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(cleanText(`${shop.operatorCount} operatori - ${shop.transactions} transazioni`), 20, currentY + 6);
                doc.text(cleanText(`Venduto: EUR ${shop.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})} - ` +
                         `Provvigioni: EUR ${shop.commission.toLocaleString('it-IT', {minimumFractionDigits: 2})}`), 20, currentY + 12);

                currentY += 20;

                // Operators table for this shop
                const tableData = [];
                shop.operators.forEach((operator, index) => {
                    const position = index === 0 ? '1°' : index === 1 ? '2°' : index === 2 ? '3°' : `${index + 1}°`;
                    const rateDisplay = operator.isCustomRate ? `${(operator.rate * 100).toFixed(2)}% *` : `${(operator.rate * 100).toFixed(2)}%`;

                    tableData.push([
                        position,
                        cleanText(operator.operatore),
                        rateDisplay,
                        `EUR ${operator.totalSales.toLocaleString('it-IT', {minimumFractionDigits: 2})}`,
                        `EUR ${operator.commission.toLocaleString('it-IT', {minimumFractionDigits: 2})}`,
                        `${operator.percentageInShop.toFixed(2)}%`,
                        operator.transactions.toString()
                    ]);
                });

                // Auto table for operators
                doc.autoTable({
                    startY: currentY,
                    head: [['Pos.', 'Operatore', '% Rate', 'Venduto (EUR)', 'Provvigione (EUR)', '% Negozio', 'Trans.']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [76, 175, 80],
                        textColor: [255, 255, 255],
                        fontSize: 8,
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 15 }, // Position
                        1: { cellWidth: 40 }, // Operatore
                        2: { halign: 'center', cellWidth: 20 }, // Rate
                        3: { halign: 'right', cellWidth: 25 }, // Venduto
                        4: { halign: 'right', cellWidth: 25 }, // Provvigione
                        5: { halign: 'center', cellWidth: 20 }, // % Negozio
                        6: { halign: 'center', cellWidth: 15 } // Transazioni
                    },
                    margin: { left: 20, right: 20 },
                    didDrawCell: function (data) {
                        // Highlight top 3 performers
                        if (data.section === 'body') {
                            const rowIndex = data.row.index;
                            if (rowIndex === 0) {
                                doc.setFillColor(255, 215, 0, 0.3); // Gold
                            } else if (rowIndex === 1) {
                                doc.setFillColor(192, 192, 192, 0.3); // Silver
                            } else if (rowIndex === 2) {
                                doc.setFillColor(205, 127, 50, 0.3); // Bronze
                            }
                        }
                    }
                });

                currentY = doc.lastAutoTable.finalY + 10;

                // Add some spacing between shops
                if (shopIndex < pivotData.length - 1) {
                    currentY += 5;
                }
            });

            // Footer with legend
            doc.addPage();
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(cleanText('[NOTE] LEGENDA E NOTE'), 20, 30);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(cleanText('* = Percentuale personalizzata applicata'), 20, 45);
            doc.text(cleanText('1° 2° 3° = Top 3 performers per negozio'), 20, 52);
            doc.text(cleanText('[GOLD] [SILVER] [BRONZE] = Top 3 venditori globali'), 20, 59);
            doc.text(cleanText('% Negozio = Percentuale delle vendite dell\'operatore sul totale del negozio'), 20, 66);
            doc.text(cleanText('[SHOP] = Indica sezione negozio'), 20, 73);
            doc.text(cleanText('[STAR] = Classifica globale venditori'), 20, 80);
            doc.text(cleanText('[CHART] = Report di analisi vendite'), 20, 87);
            doc.text(cleanText('EUR = Valuta Euro'), 20, 94);

            doc.setFontSize(8);
            doc.setTextColor(128);
            doc.text(cleanText('Generato automaticamente dall\'Analizzatore Vendite'), 105, 280, { align: 'center' });

            // Generate filename with current date
            const filename = `analisi-vendite-${new Date().toISOString().split('T')[0]}.pdf`;

            // Save the PDF
            doc.save(filename);

            // Show success message
            setTimeout(() => {
                alert(`Report PDF generato con successo!\n\nFile: ${filename}\n\nDettagli inclusi:\n• ${totalShops} negozi analizzati\n• ${totalOperators} operatori\n• Vendite totali: EUR ${totalSales.toLocaleString('it-IT')}\n• Provvigioni ${modeText.toLowerCase()}`);
            }, 500);
        }
    </script>
</body>
</html>